name: Sync Demo Branch

on:
  push:
    branches:
      - main
    paths:
      - 'web/**'
      - '.github/workflows/sync-demo.yml'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  sync-demo:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Configure Git
        run: |
          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"

      - name: Apply Demo Overrides
        run: |
          cd web
          echo "Applying demo overrides inside web/..."
          ls -R demo-overrides
          
          # Remove destination config to ensure overwrite
          rm -f next.config.ts
          
          # Use rsync for reliable directory merging
          rsync -av demo-overrides/ .
          
          # Explicitly copy the config override if rsync missed it (due to rename)
          if [ -f demo-overrides/next.config.ts.override ]; then
            cp demo-overrides/next.config.ts.override next.config.ts
          fi
          
          rm -rf demo-overrides
          # Explicitly remove from git index if it exists
          git rm -r --ignore-unmatch demo-overrides
          
          # Strip 'use server' directives from actions to allow client-side execution
          echo "Stripping 'use server' directives..."
          find src/app/actions -name "*.ts" -exec sed -i "s/'use server'//g" {} +
          
          echo "Verifying content:"
          ls -la
          cat next.config.ts
          
          echo "Verifying storage.ts content:"
          head -n 10 src/lib/storage.ts
          
          # Verify a key file changed
          if grep -q "@prisma/client" src/components/user-switcher.tsx; then
            echo "Error: Overrides failed. @prisma/client still found in user-switcher.tsx"
            exit 1
          fi
          echo "Overrides applied successfully."

      - name: Commit and Push to Demo
        run: |
          cd web
          git add .
          git commit -m "chore: Sync demo branch with main" || echo "No changes to commit"
          git push -f origin HEAD:demo
